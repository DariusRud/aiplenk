<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIPLENK Prototipas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Papildomi stiliai sklandesniam veikimui */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-nauja { background-color: #e0e7ff; color: #3730a3; }
        .status-reikia-perziuros { background-color: #fef3c7; color: #92400e; }
        .status-validuota { background-color: #d1fae5; color: #065f46; }

        /* FR-3 EiluÄiÅ³ statusai */
        .item-status-atpazinta { border-left: 4px solid #10b981; }
        .item-status-reikia-patvirtinimo { border-left: 4px solid #f59e0b; background-color: #fefce8; }
        .item-status-neatpazinta { border-left: 4px solid #ef4444; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-gray-100 font-sans" x-data="aiplenkApp()">

    <div class="flex h-screen">
        <!-- Å oninis meniu -->
        <nav class="w-64 bg-white shadow-md flex flex-col">
            <div class="p-6 text-2xl font-bold text-indigo-700">AIPLENK</div>
            <ul class="flex-grow">
                <li><a @click.prevent="currentView = 'dashboard'" href="#" class="flex items-center p-4 text-gray-700 hover:bg-gray-50" :class="{ 'bg-indigo-50 text-indigo-700 font-semibold': currentView === 'dashboard' }"><i class="fas fa-chart-pie w-6 mr-3"></i>Analitika</a></li>
                <li><a @click.prevent="currentView = 'invoices'" href="#" class="flex items-center p-4 text-gray-700 hover:bg-gray-50" :class="{ 'bg-indigo-50 text-indigo-700 font-semibold': currentView === 'invoices' }"><i class="fas fa-file-invoice w-6 mr-3"></i>SÄ…skaitos</a></li>
                <li><a @click.prevent="currentView = 'products'" href="#" class="flex items-center p-4 text-gray-700 hover:bg-gray-50" :class="{ 'bg-indigo-50 text-indigo-700 font-semibold': currentView === 'products' }"><i class="fas fa-boxes w-6 mr-3"></i>PrekiÅ³ Medis</a></li>
                <li><a @click.prevent="currentView = 'export'" href="#" class="flex items-center p-4 text-gray-700 hover:bg-gray-50" :class="{ 'bg-indigo-50 text-indigo-700 font-semibold': currentView === 'export' }"><i class="fas fa-file-export w-6 mr-3"></i>Eksportas</a></li>
            </ul>
        </nav>

        <!-- Pagrindinis turinys -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-semibold text-gray-800" x-text="viewTitle"></h1>
                <button @click="showUploadModal = true" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                    <i class="fas fa-plus mr-2"></i> Ä®kelti SÄ…skaitÄ… (FR-1)
                </button>
            </div>

            <!-- NÄ—ra sÄ…skaitÅ³ praneÅ¡imas -->
            <template x-if="invoices.length === 0 && currentView === 'invoices'">
                <div class="bg-white p-12 rounded-lg shadow-md text-center">
                    <i class="fas fa-file-alt text-6xl text-gray-300 mb-4"></i>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-2">Kol kas sÄ…skaitÅ³ nÄ—ra</h2>
                    <p class="text-gray-500 mb-6">PradÄ—kite darbÄ… Ä¯keldami pirmÄ…jÄ… sÄ…skaitÄ….</p>
                    <button @click="showUploadModal = true" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md">
                        Ä®kelti SÄ…skaitÄ…
                    </button>
                </div>
            </template>

            <!-- Analitikos Skydelis (FR-5) -->
            <div x-show="currentView === 'dashboard'">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">IÅ¡ viso Ä¯kelta</p>
                                <p class="text-3xl font-bold text-gray-800" x-text="stats.totalUploaded"></p>
                            </div>
                            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                                <i class="fas fa-upload fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Reikia PerÅ¾iÅ«ros</p>
                                <p class="text-3xl font-bold text-yellow-600" x-text="stats.needsReview"></p>
                            </div>
                            <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full">
                                <i class="fas fa-exclamation-triangle fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">KorekcijÅ³ Atlikta</p>
                                <p class="text-3xl font-bold text-gray-800" x-text="stats.correctionsMade"></p>
                            </div>
                            <div class="bg-gray-100 text-gray-600 p-3 rounded-full">
                                <i class="fas fa-pencil-alt fa-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Validuota</p>
                                <p class="text-3xl font-bold text-green-600" x-text="stats.validated"></p>
                            </div>
                            <div class="bg-green-100 text-green-600 p-3 rounded-full">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Top 5 TiekÄ—jai su Neatitikimais</h2>
                    <template x-if="stats.topProblematicSuppliers.length === 0">
                        <p class="text-gray-500">NÄ—ra tiekÄ—jÅ³, generuojanÄiÅ³ neatitikimus.</p>
                    </template>
                    <template x-for="supplier in stats.topProblematicSuppliers" :key="supplier.name">
                        <div class="flex justify-between items-center py-3 border-b last:border-b-0">
                            <span x-text="supplier.name" class="text-gray-700"></span>
                            <span class="text-red-500 font-semibold" x-text="supplier.errors + ' neatitikimai'"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- SÄ…skaitÅ³ SÄ…raÅ¡as (FR-3 Pagrindas) -->
            <div x-show="currentView === 'invoices' && invoices.length > 0">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statusas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TiekÄ—jas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SÄ…sk. Nr.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suma (be PVM)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Veiksmai</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="invoice in invoices" :key="invoice.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge" :class="statusClass(invoice.status)" x-text="invoice.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="invoice.supplier_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="invoice.invoice_number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="invoice.invoice_date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium" x-text="'â‚¬' + invoice.total_net.toFixed(2)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button @click="openInvoiceDetail(invoice.id)" class="text-indigo-600 hover:text-indigo-900">
                                            <span x-show="invoice.status === 'REIKIA PERÅ½IÅªROS'">Valdyti</span>
                                            <span x-show="invoice.status !== 'REIKIA PERÅ½IÅªROS'">PerÅ¾iÅ«rÄ—ti</span>
                                        </button>
                                        <button @click="showExportModal(invoice)" x-show="invoice.status === 'VALIDUOTA'" class="ml-4 text-green-600 hover:text-green-900" title="Eksportuoti (FR-6)">
                                            <i class="fas fa-file-export"></i>
                                        </button>
                                        <span x-show="invoice.exported" class="ml-2 text-blue-500" title="SÄ…skaita buvo eksportuota">ğŸ“¤</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PrekiÅ³ Medis (Product_Master) -->
            <div x-show="currentView === 'products'">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vidinis kodas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pavadinimas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mato vnt.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TiekÄ—jo ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TiekÄ—jo prekÄ—s kodas</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="product in productMaster" :key="product.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="product.internal_code"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.description"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.uom"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.supplier_id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.supplier_product_code"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Eksporto puslapis (FR-4) -->
            <div x-show="currentView === 'export'">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Eksportuoti Validuotas SÄ…skaitas</h2>
                    <p class="text-gray-600 mb-4">Pasirinkite sÄ…skaitas ir eksporto Å¡ablonÄ…. Eksportuoti galima tik sÄ…skaitas su statusu "VALIDUOTA".</p>
                    
                    <div class="mb-4">
                        <label for="exportTemplate" class="block text-sm font-medium text-gray-700 mb-2">Eksporto Å ablonas (FR-4)</label>
                        <select id="exportTemplate" name="exportTemplate" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>RivilÄ—s pirkimai (.csv)</option>
                            <option>Optimum pirkimai (.xlsx)</option>
                            <option>Bendra ataskaita (.csv)</option>
                        </select>
                    </div>

                    <div class="mb-6 max-h-72 overflow-y-auto border border-gray-200 rounded-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left">
                                        <input type="checkbox" @change="toggleSelectAll($event)" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TiekÄ—jas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SÄ…sk. Nr.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suma</th>
                                </a>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="invoice in getExportableInvoices()" :key="invoice.id">
                                    <tr>
                                        <td class="p-4">
                                            <input type="checkbox" x-model="invoice.selectedForExport" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                        </td>
                                        <td class="px-6 py-4 text-sm" x-text="invoice.supplier_name"></td>
                                        <td class="px-6 py-4 text-sm" x-text="invoice.invoice_number"></td>
                                        <td class="px-6 py-4 text-sm" x-text="'â‚¬' + invoice.total_net.toFixed(2)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <button @click="performExport()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-file-download mr-2"></i> Eksportuoti Pasirinktas
                    </button>
                </div>
            </div>

            <!-- PraneÅ¡imas apie sÄ—kmingÄ… veiksmÄ… -->
            <div x-show="toast.show" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2" class="fixed bottom-10 right-10 z-50">
                <div class="flex items-center rounded-lg px-6 py-4 text-white shadow-lg" :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'">
                    <i class="fas mr-3" :class="toast.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
                    <span x-text="toast.message"></span>
                </div>
            </div>

        </main>
    </div>

    <!-- SÄ…skaitos DetaliÅ³ Modal (FR-3 NeatitikimÅ³ Valdymas) -->
    <div x-show="showDetailModal" class="fixed inset-0 z-30 overflow-y-auto modal-backdrop flex items-center justify-center" style="display: none;">
        <div @click.away="showDetailModal = false" class="bg-white rounded-xl shadow-2xl w-full max-w-6xl m-8 max-h-[90vh] flex flex-col modal" x-show="showDetailModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <!-- Modal AntraÅ¡tÄ— -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800">SÄ…skaitos Valdymas (FR-3)</h2>
                    <p class="text-sm text-gray-500" x-show="currentInvoice" x-text="currentInvoice.supplier_name + ' | ' + currentInvoice.invoice_number"></p>
                </div>
                <button @click="showDetailModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-xl"></i>
                </button>
            </div>

            <!-- Modal Turinys -->
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div><strong>Statusas:</strong> <span class="status-badge" :class="statusClass(currentInvoice.status)" x-text="currentInvoice.status"></span></div>
                    <div><strong>Data:</strong> <span x-text="currentInvoice.invoice_date"></span></div>
                    <div><strong>Suma (be PVM):</strong> <span x-text="'â‚¬' + currentInvoice.total_net.toFixed(2)"></span></div>
                    <div><strong>PVM:</strong> <span x-text="'â‚¬' + currentInvoice.total_vat.toFixed(2)"></span></div>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">SÄ…skaitos eilutÄ—s</h3>
                <div class="space-y-3">
                    <!-- EilutÄ—s pavyzdys -->
                    <template x-for="(item, index) in invoiceItems.filter(i => i.invoice_id === currentInvoice.id)" :key="item.id">
                        <div class="border rounded-lg p-4" :class="itemStatusClass(item.status)">
                            <div class="grid grid-cols-12 gap-4 items-center">
                                <!-- EilutÄ—s informacija -->
                                <div class="col-span-12 md:col-span-7">
                                    <p class="font-semibold text-gray-800" x-text="item.original_description"></p>
                                    <p class="text-sm text-gray-500">
                                        <span class="mr-4"><strong>TiekÄ—jo kodas:</strong> <span x-text="item.original_supplier_code || 'N/A'"></span></span>
                                        <span class="mr-4"><strong>Kiekis:</strong> <span x-text="item.quantity"></span> <span x-text="item.original_uom"></span></span>
                                        <span><strong>Kaina:</strong> <span x-text="'â‚¬' + item.price_net.toFixed(2)"></span></span>
                                    </p>
                                </div>
                                
                                <!-- EilutÄ—s Statusas ir Veiksmai -->
                                <div class="col-span-12 md:col-span-5">
                                    <!-- ATPAÅ½INTA -->
                                    <div x-show="item.status === 'ATPAÅ½INTA'" class="flex items-center text-green-600">
                                        <i class="fas fa-check-circle fa-lg mr-2"></i>
                                        <div>
                                            <p class="font-semibold">AtpaÅ¾inta</p>
                                            <p class="text-sm" x-text="getProductName(item.product_master_id)"></p>
                                        </div>
                                    </div>

                                    <!-- REIKIA PATVIRTINIMO (FR-3) -->
                                    <div x-show="item.status === 'REIKIA PATVIRTINIMO'">
                                        <p class="font-semibold text-yellow-700 mb-2"><i class="fas fa-question-circle mr-1"></i> Sistema siÅ«lo:</p>
                                        <p class="text-sm bg-yellow-100 p-2 rounded" x-text="getProductName(item.suggested_product_id)"></p>
                                        <div class="mt-3">
                                            <button @click="confirmSuggestion(item.id)" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-md mr-2">
                                                <i class="fas fa-check mr-1"></i> Taip, Patvirtinti
                                            </button>
                                            <button @click="rejectSuggestion(item.id)" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md">
                                                <i class="fas fa-times mr-1"></i> Ne, tai kita prekÄ—
                                            </button>
                                        </div>
                                    </div>

                                    <!-- NEATPAÅ½INTA (FR-3) -->
                                    <div x-show="item.status === 'NEATPAÅ½INTA'">
                                        <p class="font-semibold text-red-700 mb-2"><i class="fas fa-times-circle mr-1"></i> NeatpaÅ¾inta</p>
                                        <p class="text-sm text-gray-600 mb-3">Susiekite Å¡iÄ… eilutÄ™ su preke iÅ¡ katalogo arba sukurkite naujÄ….</p>
                                        <button @click="openLinkModal(item.id)" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded-md">
                                            <i class="fas fa-link mr-1"></i> Ranka susieti prekÄ™
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Modal ApaÄia -->
            <div class="p-6 bg-gray-50 border-t border-gray-200 rounded-b-xl text-right">
                <button @click="showDetailModal = false" class="text-gray-700 font-medium py-2 px-4 rounded-lg mr-2">UÅ¾daryti</button>
                <button @click="validateInvoice()" :disabled="!isInvoiceResolvable()" 
                        class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md"
                        :class="{ 'opacity-50 cursor-not-allowed': !isInvoiceResolvable(), 'hover:bg-green-700': isInvoiceResolvable() }">
                    Patvirtinti SÄ…skaitÄ…
                </button>
            </div>
        </div>
    </div>

    <!-- PrekÄ—s Susiejimo Modal (FR-3 / G-1) -->
    <div x-show="showLinkModal" class="fixed inset-0 z-40 overflow-y-auto modal-backdrop flex items-center justify-center" style="display: none;">
        <div @click.away="showLinkModal = false" class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 modal" x-show="showLinkModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Susieti prekÄ™ (FR-3 / G-1)</h3>
                <p class="text-sm text-gray-500" x-show="currentItem" x-text="'Originali eilutÄ—: ' + currentItem.original_description"></p>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="productSearch" class="block text-sm font-medium text-gray-700 mb-2">IÅ¡manioji PaieÅ¡ka (G-1)</label>
                    <div class="relative">
                        <input type="text" id="productSearch" x-model="productSearchQuery" @input.debounce.300ms="searchProducts()" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md" placeholder="IeÅ¡koti pagal kodÄ… ar pavadinimÄ…...">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-md divide-y divide-gray-200">
                    <template x-if="productSearchResults.length === 0">
                        <p class="p-4 text-gray-500 text-center">ProduktÅ³ nerasta. Bandykite kitÄ… paieÅ¡kos frazÄ™.</p>
                    </template>
                    <template x-for="product in productSearchResults" :key="product.id">
                        <div class="flex justify-between items-center p-3 hover:bg-gray-50">
                            <div>
                                <p class="font-medium text-gray-900" x-text="product.description"></p>
                                <p class="text-sm text-gray-500"><span x-text="product.internal_code"></span> | <span x-text="product.supplier_id"></span> | <span x-text="product.supplier_product_code"></span></p>
                            </div>
                            <button @click="linkProduct(product.id)" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded-md">
                                Susieti
                            </button>
                        </div>
                    </template>
                </div>
            </div>
            <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    <i class="fas fa-plus mr-1"></i> Sukurti NaujÄ… PrekÄ™
                </button>
                <button @click="showLinkModal = false" class="text-gray-700 font-medium py-2 px-4 rounded-lg">AtÅ¡aukti</button>
            </div>
        </div>
    </div>

    <!-- SÄ…skaitos Ä®kÄ—limo Modal (FR-1) -->
    <div x-show="showUploadModal" class="fixed inset-0 z-30 overflow-y-auto modal-backdrop flex items-center justify-center" style="display: none;">
        <div @click.away="showUploadModal = false" class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 modal" x-show="showUploadModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Ä®kelti SÄ…skaitas (FR-1)</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Å is prototipas simuliuos sÄ…skaitÅ³ Ä¯kÄ—limÄ…. Pasirinkite, kokio tipo sÄ…skaitÄ… norite Ä¯kelti, kad pamatytumÄ—te skirtingus scenarijus.</p>
                <div class="space-y-3">
                    <button @click="simulateUpload('good')" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-file-invoice text-green-500 text-2xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-800">"Gera" SÄ…skaita</p>
                            <p class="text-sm text-gray-600">Visos eilutÄ—s bus atpaÅ¾intos (100% ATPAÅ½INTA).</p>
                        </div>
                    </button>
                    <button @click="simulateUpload('mixed')" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-file-invoice text-yellow-500 text-2xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-800">"MiÅ¡ri" SÄ…skaita</p>
                            <p class="text-sm text-gray-600">Bus eilutÄ—s visÅ³ 3 statusÅ³ (ATPAÅ½INTA, REIKIA PATVIRTINIMO, NEATPAÅ½INTA).</p>
                        </div>
                    </button>
                    <button @click="simulateUpload('bad')" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-file-invoice text-red-500 text-2xl mr-4"></i>
                        <div>
                            <p class="font-semibold text-gray-800">"Bloga" SÄ…skaita</p>
                            <p class="text-sm text-gray-600">Dauguma eiluÄiÅ³ bus NEATPAÅ½INTOS.</p>
                        </div>
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gray-50 border-t border-gray-200 text-right">
                <button @click="showUploadModal = false" class="text-gray-700 font-medium py-2 px-4 rounded-lg">AtÅ¡aukti</button>
            </div>
        </div>
    </div>

    <!-- Eksporto Modal (FR-4 / FR-6) -->
    <div x-show="showExportModalState" class="fixed inset-0 z-30 overflow-y-auto modal-backdrop flex items-center justify-center" style="display: none;">
        <div @click.away="showExportModalState = false" class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 modal" x-show="showExportModalState" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Eksportuoti SÄ…skaitÄ… (FR-4)</h3>
                <p class="text-sm text-gray-500" x-show="currentInvoice" x-text="'SÄ…skaita: ' + currentInvoice.invoice_number"></p>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">Pasirinkite eksporto Å¡ablonÄ… Å¡iai sÄ…skaitai. Kiekvienas eksportas bus uÅ¾fiksuotas audito Å¾urnale (FR-6).</p>
                <label for="modalExportTemplate" class="block text-sm font-medium text-gray-700 mb-2">Eksporto Å ablonas</label>
                <select id="modalExportTemplate" x-model="selectedTemplate" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option>RivilÄ—s pirkimai (.csv)</option>
                    <option>Optimum pirkimai (.xlsx)</option>
                    <option>Bendra ataskaita (.csv)</option>
                </select>
            </div>
            <div class="p-6 bg-gray-50 border-t border-gray-200 text-right">
                <button @click="showExportModalState = false" class="text-gray-700 font-medium py-2 px-4 rounded-lg mr-2">AtÅ¡aukti</button>
                <button @click="performSingleExport()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    <i class="fas fa-file-download mr-2"></i> Eksportuoti
                </button>
            </div>
        </div>
    </div>


    <!-- Alpine.js script -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('aiplenkApp', () => ({
                // DuomenÅ³ Modeliai (Simuliacija)
                productMaster: [
                    { id: 1, internal_code: 'VAR001', description: 'VarÅ¾tas M6x50 DIN 933', uom: 'vnt.', supplier_id: 'LT100001234512', supplier_product_code: 'SRA-M6-50' },
                    { id: 2, internal_code: 'VER001', description: 'VerÅ¾lÄ— M6 DIN 934', uom: 'vnt.', supplier_id: 'LT100001234512', supplier_product_code: 'VER-M6' },
                    { id: 3, internal_code: 'PLK001', description: 'PlokÅ¡telÄ— M6 DIN 125', uom: 'vnt.', supplier_id: 'LT100001234512', supplier_product_code: 'PL-M6' },
                    { id: 4, internal_code: 'MED001', description: 'MedÅ¾io sraigtas 3.5x40', uom: 'vnt.', supplier_id: 'LT100005678912', supplier_product_code: 'MS-3540' },
                    { id: 5, internal_code: 'MED002', description: 'MedÅ¾io sraigtas 4.0x50', uom: 'vnt.', supplier_id: 'LT100005678912', supplier_product_code: 'MS-4050' },
                    { id: 6, internal_code: 'GRT001', description: 'GrÄ…Å¾tas metalui 5mm', uom: 'vnt.', supplier_id: 'LT100009876543', supplier_product_code: 'G-MET-5' }
                ],
                invoices: [],
                invoiceItems: [],
                exportLog: [],
                
                // BÅ«sena
                currentView: 'dashboard',
                showDetailModal: false,
                showLinkModal: false,
                showUploadModal: false,
                showExportModalState: false,
                currentInvoiceId: null,
                currentItemId: null,
                productSearchQuery: '',
                productSearchResults: [],
                selectedTemplate: 'RivilÄ—s pirkimai (.csv)',

                // PraneÅ¡imÅ³ (Toast) bÅ«sena
                toast: {
                    show: false,
                    message: '',
                    type: 'success'
                },

                // Statistikos objektas (FR-5)
                stats: {
                    totalUploaded: 0,
                    needsReview: 0,
                    correctionsMade: 0,
                    validated: 0,
                    topProblematicSuppliers: []
                },

                // Getteriai ir pagalbinÄ—s funkcijos
                get currentInvoice() {
                    return this.invoices.find(inv => inv.id === this.currentInvoiceId) || { total_net: 0, total_vat: 0 };
                },
                get currentItem() {
                    return this.invoiceItems.find(item => item.id === this.currentItemId) || { original_description: '' };
                },
                get viewTitle() {
                    switch(this.currentView) {
                        case 'dashboard': return 'Analitikos Skydelis (FR-5)';
                        case 'invoices': return 'SÄ…skaitÅ³ SÄ…raÅ¡as';
                        case 'products': return 'PrekiÅ³ Medis (Product_Master)';
                        case 'export': return 'Eksportas (FR-4)';
                        default: return 'AIPLENK';
                    }
                },
                
                init() {
                    this.updateStats();
                },

                // Statistikos atnaujinimas (FR-5)
                updateStats() {
                    this.stats.totalUploaded = this.invoices.length;
                    this.stats.needsReview = this.invoices.filter(inv => inv.status === 'REIKIA PERÅ½IÅªROS').length;
                    this.stats.validated = this.invoices.filter(inv => inv.status === 'VALIDUOTA').length;
                    // 'correctionsMade' yra simuliuojamas
                    
                    // Simuliuojam top tiekÄ—jus su problemomis
                    const supplierErrors = {};
                    this.invoiceItems
                        .filter(item => item.original_status === 'NEATPAÅ½INTA' || item.original_status === 'REIKIA PATVIRTINIMO')
                        .forEach(item => {
                            const invoice = this.invoices.find(inv => inv.id === item.invoice_id);
                            if (invoice) {
                                if (!supplierErrors[invoice.supplier_name]) {
                                    supplierErrors[invoice.supplier_name] = 0;
                                }
                                supplierErrors[invoice.supplier_name]++;
                            }
                        });
                    
                    this.stats.topProblematicSuppliers = Object.entries(supplierErrors)
                        .map(([name, errors]) => ({ name, errors }))
                        .sort((a, b) => b.errors - a.errors)
                        .slice(0, 5);
                },

                // Simuliuoti Ä®kÄ—limÄ… (FR-1)
                simulateUpload(type) {
                    const newInvoiceId = Date.now();
                    let newInvoice = {};
                    let newItems = [];
                    let overallStatus = 'VALIDUOTA'; // Pagal nutylÄ—jimÄ…

                    switch(type) {
                        case 'good':
                            newInvoice = { id: newInvoiceId, supplier_name: 'UAB "Tvirtas VarÅ¾tas"', supplier_id: 'LT100001234512', invoice_number: 'TV-' + Math.floor(Math.random() * 1000), invoice_date: '2025-10-28', total_net: 15.00, total_vat: 3.15, status: 'VALIDUOTA', exported: false, selectedForExport: false };
                            newItems = [
                                { id: newInvoiceId + 1, invoice_id: newInvoiceId, product_master_id: 1, original_description: 'VarÅ¾tas M6x50', original_supplier_code: 'SRA-M6-50', original_uom: 'vnt', quantity: 100, price_net: 0.10, status: 'ATPAÅ½INTA', original_status: 'ATPAÅ½INTA' },
                                { id: newInvoiceId + 2, invoice_id: newInvoiceId, product_master_id: 2, original_description: 'VerÅ¾lÄ— M6', original_supplier_code: 'VER-M6', original_uom: 'vnt', quantity: 100, price_net: 0.05, status: 'ATPAÅ½INTA', original_status: 'ATPAÅ½INTA' }
                            ];
                            overallStatus = 'VALIDUOTA';
                            break;
                        case 'mixed':
                            newInvoice = { id: newInvoiceId, supplier_name: 'UAB "StatybÅ³ Partneris"', supplier_id: 'LT100005678912', invoice_number: 'SP-' + Math.floor(Math.random() * 1000), invoice_date: '2025-10-27', total_net: 42.50, total_vat: 8.93, status: 'REIKIA PERÅ½IÅªROS', exported: false, selectedForExport: false };
                            newItems = [
                                { id: newInvoiceId + 1, invoice_id: newInvoiceId, product_master_id: 4, original_description: 'MedÅ¾io sraigtas 3.5x40', original_supplier_code: 'MS-3540', original_uom: 'vnt', quantity: 200, price_net: 0.15, status: 'ATPAÅ½INTA', original_status: 'ATPAÅ½INTA' },
                                { id: newInvoiceId + 2, invoice_id: newInvoiceId, product_master_id: null, original_description: 'MedÅ¾io sraigtas 4.0x50mm', original_supplier_code: 'MS-4050', original_uom: 'vnt', quantity: 100, price_net: 0.20, status: 'REIKIA PATVIRTINIMO', original_status: 'REIKIA PATVIRTINIMO', suggested_product_id: 5 }, // Simuliuojam panaÅ¡umÄ… (FR-2)
                                { id: newInvoiceId + 3, invoice_id: newInvoiceId, product_master_id: null, original_description: 'Vinys 100mm', original_supplier_code: 'VIN-100', original_uom: 'kg', quantity: 1, price_net: 2.50, status: 'NEATPAÅ½INTA', original_status: 'NEATPAÅ½INTA' } // Simuliuojam neatpaÅ¾intÄ… (FR-2)
                            ];
                            overallStatus = 'REIKIA PERÅ½IÅªROS';
                            break;
                        case 'bad':
                            newInvoice = { id: newInvoiceId, supplier_name: 'UAB "NeÅ¾inomi Ä®rankiai"', supplier_id: 'LT100009876543', invoice_number: 'NI-' + Math.floor(Math.random() * 1000), invoice_date: '2025-10-26', total_net: 18.00, total_vat: 3.78, status: 'REIKIA PERÅ½IÅªROS', exported: false, selectedForExport: false };
                            newItems = [
                                { id: newInvoiceId + 1, invoice_id: newInvoiceId, product_master_id: null, original_description: 'GrÄ…Å¾tas 5mm', original_supplier_code: 'G-MET-5', original_uom: 'vnt', quantity: 2, price_net: 4.00, status: 'REIKIA PATVIRTINIMO', original_status: 'REIKIA PATVIRTINIMO', suggested_product_id: 6 }, // PanaÅ¡us pavadinimas
                                { id: newInvoiceId + 2, invoice_id: newInvoiceId, product_master_id: null, original_description: 'Atsuktuvas PH2', original_supplier_code: 'AT-PH2', original_uom: 'vnt', quantity: 1, price_net: 5.00, status: 'NEATPAÅ½INTA', original_status: 'NEATPAÅ½INTA' },
                                { id: newInvoiceId + 3, invoice_id: newInvoiceId, product_master_id: null, original_description: 'Plaktukas 500g', original_supplier_code: 'PL-500', original_uom: 'vnt', quantity: 1, price_net: 5.00, status: 'NEATPAÅ½INTA', original_status: 'NEATPAÅ½INTA' }
                            ];
                            overallStatus = 'REIKIA PERÅ½IÅªROS';
                            break;
                    }
                    
                    newInvoice.status = overallStatus;
                    this.invoices.unshift(newInvoice);
                    this.invoiceItems.push(...newItems);
                    
                    this.showUploadModal = false;
                    this.showToast('SÄ…skaita sÄ—kmingai simuliuota ir Ä¯kelta.', 'success');
                    this.currentView = 'invoices';
                    this.updateStats();
                },

                // ModalÅ³ valdymas
                openInvoiceDetail(invoiceId) {
                    this.currentInvoiceId = invoiceId;
                    this.showDetailModal = true;
                },
                openLinkModal(itemId) {
                    this.currentItemId = itemId;
                    this.productSearchQuery = this.currentItem.original_description.substring(0, 10); // PradinÄ— paieÅ¡ka
                    this.searchProducts();
                    this.showLinkModal = true;
                },

                // NeatitikimÅ³ Valdymas (FR-3)
                confirmSuggestion(itemId) {
                    const item = this.invoiceItems.find(i => i.id === itemId);
                    item.product_master_id = item.suggested_product_id;
                    item.status = 'ATPAÅ½INTA';
                    this.stats.correctionsMade++;
                    this.showToast('PrekÄ— sÄ—kmingai patvirtinta.', 'success');
                    this.checkInvoiceStatus(item.invoice_id);
                },
                rejectSuggestion(itemId) {
                    const item = this.invoiceItems.find(i => i.id === itemId);
                    item.status = 'NEATPAÅ½INTA';
                    item.suggested_product_id = null;
                    this.stats.correctionsMade++;
                },
                linkProduct(productId) {
                    const item = this.invoiceItems.find(i => i.id === this.currentItemId);
                    item.product_master_id = productId;
                    item.status = 'ATPAÅ½INTA';
                    this.stats.correctionsMade++;
                    this.showToast('PrekÄ— sÄ—kmingai susieta.', 'success');
                    this.showLinkModal = false;
                    this.checkInvoiceStatus(item.invoice_id);
                },
                
                // Patikrina, ar visos sÄ…skaitos eilutÄ—s iÅ¡sprÄ™stos
                checkInvoiceStatus(invoiceId) {
                    const items = this.invoiceItems.filter(i => i.invoice_id === invoiceId);
                    const allResolved = items.every(i => i.status === 'ATPAÅ½INTA');
                    if (allResolved) {
                        // NÄ—ra aktyvaus modal, atnaujinam fone
                        if (!this.showDetailModal) {
                            const invoice = this.invoices.find(inv => inv.id === invoiceId);
                            if (invoice.status !== 'VALIDUOTA') {
                                invoice.status = 'VALIDUOTA';
                                this.showToast(`SÄ…skaita ${invoice.invoice_number} automatiÅ¡kai validuota.`, 'success');
                                this.updateStats();
                            }
                        }
                    }
                },
                
                isInvoiceResolvable() {
                    if (!this.currentInvoiceId) return false;
                    const items = this.invoiceItems.filter(i => i.invoice_id === this.currentInvoiceId);
                    return items.every(i => i.status === 'ATPAÅ½INTA');
                },
                
                validateInvoice() {
                    if (this.isInvoiceResolvable()) {
                        this.currentInvoice.status = 'VALIDUOTA';
                        this.showDetailModal = false;
                        this.showToast('SÄ…skaita sÄ—kmingai validuota.', 'success');
                        this.updateStats();
                    }
                },

                // PaieÅ¡ka (G-1)
                searchProducts() {
                    if (this.productSearchQuery.length < 2) {
                        this.productSearchResults = this.productMaster.slice(0, 5); // Rodyti kelis pagal nutylÄ—jimÄ…
                        return;
                    }
                    const query = this.productSearchQuery.toLowerCase();
                    this.productSearchResults = this.productMaster.filter(p => 
                        p.description.toLowerCase().includes(query) ||
                        p.internal_code.toLowerCase().includes(query) ||
                        p.supplier_product_code.toLowerCase().includes(query)
                    ).slice(0, 10);
                },

                // Eksportas (FR-4 / FR-6)
                showExportModal(invoice) {
                    this.currentInvoiceId = invoice.id;
                    this.showExportModalState = true;
                },
                performSingleExport() {
                    this.exportLog.push({ 
                        invoice_id: this.currentInvoiceId, 
                        template: this.selectedTemplate, 
                        timestamp: new Date().toISOString() 
                    });
                    this.currentInvoice.exported = true; // FR-6 indikatorius
                    this.showExportModalState = false;
                    this.showToast(`SÄ…skaita eksportuota su "${this.selectedTemplate}" Å¡ablonu.`, 'success');
                },

                getExportableInvoices() {
                    return this.invoices.filter(inv => inv.status === 'VALIDUOTA');
                },
                
                toggleSelectAll(event) {
                    this.getExportableInvoices().forEach(inv => inv.selectedForExport = event.target.checked);
                },

                performExport() {
                    const selectedInvoices = this.getExportableInvoices().filter(inv => inv.selectedForExport);
                    if (selectedInvoices.length === 0) {
                        this.showToast('Pasirinkite bent vienÄ… sÄ…skaitÄ… eksportui.', 'error');
                        return;
                    }
                    
                    selectedInvoices.forEach(inv => {
                        this.exportLog.push({ 
                            invoice_id: inv.id, 
                            template: this.selectedTemplate, // ReikÄ—tÅ³ gauti iÅ¡ select
                            timestamp: new Date().toISOString() 
                        });
                        inv.exported = true; // FR-6 indikatorius
                        inv.selectedForExport = false; // Nustatyti atgal
                    });

                    this.showToast(`SÄ—kmingai eksportuota ${selectedInvoices.length} sÄ…skaitÅ³.`, 'success');
                },


                // PagalbinÄ—s UI funkcijos
                getProductName(productId) {
                    return this.productMaster.find(p => p.id === productId)?.description || 'N/A';
                },
                statusClass(status) {
                    return {
                        'NAUJA': 'status-nauja',
                        'REIKIA PERÅ½IÅªROS': 'status-reikia-perziuros',
                        'VALIDUOTA': 'status-validuota'
                    }[status] || 'bg-gray-200 text-gray-800';
                },
                itemStatusClass(status) {
                     return {
                        'ATPAÅ½INTA': 'item-status-atpazinta',
                        'REIKIA PATVIRTINIMO': 'item-status-reikia-patvirtinimo',
                        'NEATPAÅ½INTA': 'item-status-neatpazinta'
                    }[status] || '';
                },

                showToast(message, type = 'success') {
                    this.toast.message = message;
                    this.toast.type = type;
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }));
        });
    </script>
</body>
</html>